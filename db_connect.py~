import mysql.connector
import json


class RequestLogDAO:
    def __init__(self):
        self.config = {
            'host': 'gateway01.eu-central-1.prod.aws.tidbcloud.com',
            'port': 4000,
            'user': '4ENu2fmodh5VFH8.root',
            'password': 'u9jstw7C7SIdGjaD',
            'database': 'test',
            'ssl_disabled': False
        }
        self.conn = None
        self.cursor = None

    def connect(self):
        self.conn = mysql.connector.connect(**self.config)
        self.cursor = self.conn.cursor()

    def close(self):
        if self.cursor:
            self.cursor.close()
        if self.conn and self.conn.is_connected():
            self.conn.close()

    def update_field(self, id_request, field_name, new_value):
        query = f"UPDATE request_log SET {field_name} = %s WHERE id_request = %s"

        # Se il valore √® un dict, lo convertiamo in JSON
        if isinstance(new_value, dict):
            new_value = json.dumps(new_value)

        self.cursor.execute(query, (new_value, id_request))
        self.conn.commit()
        return self.cursor.rowcount

    def insert_request(self, request_text, response_text):
        query = """
            INSERT INTO request_log (request, response)
            VALUES (%s, %s)
        """

        # Converti in stringa JSON se sono dizionari
        if isinstance(request_text, dict):
            request_text = json.dumps(request_text)
        if isinstance(response_text, dict):
            response_text = json.dumps(response_text)

        self.cursor.execute(query, (request_text, response_text))
        self.conn.commit()
        return self.cursor.lastrowid

    def delete_request(self, id_request):
        query = "DELETE FROM request_log WHERE id_request = %s"
        self.cursor.execute(query, (id_request,))
        self.conn.commit()
        return self.cursor.rowcount


class RequestLogServer:
    def __init__(self):
        self.dao = RequestLogDAO()
        # self.dao = ApiRequestDAO()

    def insert_request(self, request_text, response_text):
        try:
            self.dao.connect()
            inserted_id = self.dao.insert_request(request_text, response_text)
            print(f"‚úÖ Inserito record con ID: {inserted_id}")
            return inserted_id
        except Exception as e:
            print(f"‚ùå Errore durante l'inserimento: {e}")
            return None
        finally:
            self.dao.close()

    def update_field(self, id_request, field_name, new_value):
        try:
            self.dao.connect()
            updated = self.dao.update_field(id_request, field_name, new_value)
            print(f"üîÑ Campo '{field_name}' aggiornato per ID {id_request}")
            return updated
        except Exception as e:
            print(f"‚ùå Errore durante l'update generico: {e}")
            return None
        finally:
            self.dao.close()

    def update_response(self, id_request, new_response):
        return self.update_field(id_request, "response", new_response)


class ApiRequestDAO:
    def __init__(self):
        self.config = {
            'host': 'gateway01.eu-central-1.prod.aws.tidbcloud.com',
            'port': 4000,
            'user': '4ENu2fmodh5VFH8.root',
            'password': 'u9jstw7C7SIdGjaD',
            'database': 'test',
            'ssl_disabled': False
        }
        self.conn = None
        self.cursor = None

    def connect(self):
        self.conn = mysql.connector.connect(**self.config)
        self.cursor = self.conn.cursor()

    def close(self):
        if self.cursor:
            self.cursor.close()
        if self.conn and self.conn.is_connected():
            self.conn.close()

    def insert_request(self, request_text, response_text):
        query = """
            INSERT INTO api_requests (
                endpoint, body, headers, payload,
                response_status, response_body, response_json,
                response_data, response_code, response_msg
            ) VALUES ( %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """

        if isinstance(request_text, dict):
            request_text = json.dumps(request_text)
        if isinstance(response_text, dict):
            response_text = json.dumps(response_text)

        req = json.loads(request_text)
        res = json.loads(response_text)

        values = (
                  req.get("endpoint"),
                  req.get("body"),
                  req.get("headers"),
                  req.get("payload"),
                  res.get("response_status"),
                  res.get("response_body"),
                  res.get("response_json"),
                  res.get("response_data"),
                  res.get("response_code"),
                  res.get("response_msg")
                  )

        self.cursor.execute(query, values)
        self.conn.commit()
        return req.get("id_request")

    def update_field(self, id_request, field_name, new_value):
        query = f"UPDATE api_requests SET {field_name} = %s WHERE id_request = %s"

        if isinstance(new_value, dict):
            new_value = json.dumps(new_value)

        self.cursor.execute(query, (new_value, id_request))
        self.conn.commit()
        return self.cursor.rowcount

    def delete_request(self, id_request):
        query = "DELETE FROM api_requests WHERE id_request = %s"
        self.cursor.execute(query, (id_request,))
        self.conn.commit()
        return self.cursor.rowcount


class RequestLogApiServer:
    def __init__(self, use_api_requests=False):
        self.dao = ApiRequestDAO()  # if use_api_requests else RequestLogDAO()

    def insert_request(self,signal_id, request_text, response_text):
        try:
            self.dao.connect()
            inserted_id = self.dao.insert_request(signal_id,request_text, response_text)
            print(f"‚úÖ Inserito record con ID: {inserted_id}")
            return inserted_id
        except Exception as e:
            print(f"‚ùå Errore durante l'inserimento: {e}")
            return None
        finally:
            self.dao.close()

    def update_field(self, id_request, field_name, new_value):
        try:
            self.dao.connect()
            updated = self.dao.update_field(id_request, field_name, new_value)
            print(f"üîÑ Campo '{field_name}' aggiornato per ID {id_request}")
            return updated
        except Exception as e:
            print(f"‚ùå Errore durante l'update generico: {e}")
            return None
        finally:
            self.dao.close()

    def delete_request(self, id_request):
        try:
            self.dao.connect()
            deleted = self.dao.delete_request(id_request)
            print(f"üóëÔ∏è Eliminato record con ID: {id_request}")
            return deleted
        except Exception as e:
            print(f"‚ùå Errore durante la cancellazione: {e}")
            return None
        finally:
            self.dao.close()
